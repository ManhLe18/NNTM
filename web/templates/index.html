<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠n di·ªán b·ªánh l√∫a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Quicksand', Arial, sans-serif;
            background: linear-gradient(120deg, #e8f5e9 0%, #fffde7 100%);
            min-height: 100vh;
        }
        .main-title {
            font-weight: 700;
            color: #388e3c;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        .slogan {
            color: #8d6e63;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        .card {
            border: none;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(56, 142, 60, 0.08), 0 1.5px 6px rgba(0,0,0,0.04);
            margin-bottom: 24px;
        }
        .card-title {
            color: #388e3c;
            font-weight: 700;
        }
        .btn-primary, .btn-success {
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(56, 142, 60, 0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover, .btn-success:hover {
            background: #43a047;
            box-shadow: 0 4px 16px rgba(56, 142, 60, 0.15);
        }
        #preview, #esp32LiveView {
            max-width: 100%;
            max-height: 320px;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(56, 142, 60, 0.10);
            border: 3px solid #c8e6c9;
            margin-top: 10px;
        }
        .camera-container {
            position: relative;
        }
        .camera-status {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(56, 142, 60, 0.85);
            color: #fff;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(56, 142, 60, 0.10);
        }
        .result-box {
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 2px 12px rgba(255, 235, 59, 0.10);
            padding: 28px 24px;
            margin-top: 24px;
        }
        .confidence-bar {
            height: 18px;
            background: linear-gradient(90deg, #43a047 0%, #fffde7 100%);
            border-radius: 6px;
            margin-top: 4px;
        }
        .history-img {
            max-width: 90px;
            max-height: 70px;
            border: 2px solid #c8e6c9;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(56, 142, 60, 0.08);
        }
        .table {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
        }
        .chatbot-box {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 350px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(56, 142, 60, 0.12);
            z-index: 1000;
            border: 2px solid #c8e6c9;
        }
        .chatbot-header {
            background: #388e3c;
            color: #fff;
            padding: 14px;
            border-radius: 16px 16px 0 0;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .chatbot-messages {
            max-height: 250px;
            overflow-y: auto;
            padding: 12px;
        }
        .chatbot-input {
            display: flex;
            border-top: 1px solid #eee;
            padding: 8px;
        }
        .chatbot-input input {
            flex: 1;
            border: none;
            padding: 12px;
            font-size: 1rem;
        }
        .chatbot-input button {
            border: none;
            background: #43a047;
            color: #fff;
            padding: 0 22px;
            font-weight: 600;
            border-radius: 8px;
            margin-left: 8px;
        }
        .chatbot-upload {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-top: 1px solid #eee;
        }
        .chatbot-upload button {
            flex: 1;
            border: none;
            background: #e8f5e9;
            color: #388e3c;
            padding: 8px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chatbot-upload button:hover {
            background: #c8e6c9;
        }
        .chatbot-upload input[type="file"] {
            display: none;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
        }
        .user-message {
            background: #e8f5e9;
            margin-left: auto;
        }
        .bot-message {
            background: #f5f5f5;
        }
        .chat-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .chat-file {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 8px;
            margin-top: 8px;
        }
        .chat-file i {
            font-size: 24px;
            color: #388e3c;
        }
        @media (max-width: 991px) {
            .chatbot-box { right: 10px; bottom: 10px; width: 98vw; }
        }
        @media (max-width: 767px) {
            .main-title { font-size: 1.5rem; }
            .container { padding: 0 2px; }
            .chatbot-box { width: 100vw; left: 0; right: 0; }
        }
    </style>
</head>
<body>
    <div class="container py-4 mb-5">
        <div class="text-center">
            <h1 class="main-title">üåæ Nh·∫≠n di·ªán b·ªánh l√∫a th√¥ng minh</h1>
            <div class="slogan">·ª®ng d·ª•ng AI gi√∫p n√¥ng d√¢n ph√°t hi·ªán b·ªánh l√∫a nhanh ch√≥ng, ch√≠nh x√°c v√† d·ªÖ d√†ng.</div>
        </div>
        <div class="row g-4">
            <!-- Upload ·∫£nh -->
            <div class="col-lg-6 col-md-12">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title">T·∫£i ·∫£nh l√™n</h5>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="imageInput" accept="image/*">
                            </div>
                            <button type="submit" class="btn btn-primary">D·ª± ƒëo√°n</button>
                        </form>
                        <img id="preview" class="d-none mt-2">
                    </div>
                </div>
            </div>
            <!-- ESP32 Camera -->
            <div class="col-lg-6 col-md-12">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title">Camera ESP32</h5>
                        <div class="camera-container mb-2">
                            <img id="esp32LiveView" src="http://{{ esp32_ip }}/stream" />
                            <div class="camera-status" id="cameraStatus">ƒêang k·∫øt n·ªëi...</div>
                        </div>
                        <button onclick="predictEsp32()" class="btn btn-success">Ch·ª•p v√† d·ª± ƒëo√°n</button>
                    </div>
                </div>
            </div>
            <!-- Webcam -->
            <div class="col-lg-6 col-md-12">
                <div class="card p-3">
                    <div class="card-body">
                        <h5 class="card-title">Camera m√°y t√≠nh</h5>
                        <div class="camera-container mb-2">
                            <video id="webcam" autoplay playsinline style="width: 100%; border-radius: 14px; border: 3px solid #c8e6c9;"></video>
                            <canvas id="webcamCanvas" style="display: none;"></canvas>
                            <div class="camera-status" id="webcamStatus">ƒêang kh·ªüi t·∫°o...</div>
                        </div>
                        <button onclick="startWebcam()" class="btn btn-primary me-2">B·∫≠t camera</button>
                        <button onclick="captureAndPredict()" class="btn btn-success" id="captureBtn" disabled>Ch·ª•p v√† d·ª± ƒëo√°n</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- K·∫øt qu·∫£ -->
        <div class="result-box d-none" id="resultBox">
            <h4 class="mb-3" style="color:#fbc02d; font-weight:700;">K·∫øt qu·∫£ d·ª± ƒëo√°n</h4>
            <div id="resultContent"></div>
            <div id="diseaseInfo" class="mt-3"></div>
        </div>
        <!-- L·ªãch s·ª≠ d·ª± ƒëo√°n -->
        <div class="mt-5">
            <h4 style="color:#388e3c; font-weight:700;">L·ªãch s·ª≠ d·ª± ƒëo√°n</h4>
            <div id="historyTable"></div>
        </div>
        <!-- N√∫t xem l·ªãch s·ª≠ chat v√† modal -->
        <button class="btn btn-secondary mt-3" onclick="showChatHistory()">Xem l·ªãch s·ª≠ chat</button>

        <div class="modal fade" id="chatHistoryModal" tabindex="-1" aria-labelledby="chatHistoryModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="chatHistoryModalLabel">L·ªãch s·ª≠ h·ªôi tho·∫°i Chatbot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" id="chatHistoryContent">
                <!-- L·ªãch s·ª≠ s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
              </div>
            </div>
          </div>
        </div>

        <!-- Th√™m modal so s√°nh ·∫£nh -->
        <div class="modal fade" id="compareModal" tabindex="-1" aria-labelledby="compareModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="compareModalLabel">So s√°nh k·∫øt qu·∫£ d·ª± ƒëo√°n</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>·∫¢nh g·ªëc</h6>
                                <img id="originalImage" class="img-fluid rounded" style="max-height: 400px;">
                            </div>
                            <div class="col-md-6">
                                <h6>K·∫øt qu·∫£ d·ª± ƒëo√°n</h6>
                                <div id="predictionResults"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Chatbot -->
    <div class="chatbot-box" id="chatbotBox">
        <div class="chatbot-header">ü§ñ T∆∞ v·∫•n b·ªánh l√∫a (Chatbot)</div>
        <div class="chatbot-messages" id="chatbotMessages"></div>
        <div class="chatbot-upload">
            <input type="file" id="chatbotImageInput" accept="image/*">
            <input type="file" id="chatbotFileInput" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx">
            <button onclick="document.getElementById('chatbotImageInput').click()">üì∑ ·∫¢nh</button>
            <button onclick="document.getElementById('chatbotFileInput').click()">üìé File</button>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatbotInput" placeholder="Nh·∫≠p c√¢u h·ªèi...">
            <button onclick="sendChatbot()">G·ª≠i</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const esp32_ip = "{{ esp32_ip }}";
        // Preview ·∫£nh
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('preview');
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                }
                reader.readAsDataURL(file);
            }
        });

        // Upload v√† d·ª± ƒëo√°n
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = document.getElementById('imageInput').files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                displayResult(result);
                loadHistory();
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // D·ª± ƒëo√°n t·ª´ ESP32
        async function predictEsp32() {
            // ·∫®n stream khi ch·ª•p
            const liveView = document.getElementById('esp32LiveView');
            const oldSrc = liveView.src;
            liveView.style.display = 'none';
            liveView.src = '';
            try {
                document.getElementById('cameraStatus').textContent = 'ƒêang x·ª≠ l√Ω...';
                const response = await fetch('/predict_esp32', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.error) {
                    document.getElementById('cameraStatus').textContent = 'L·ªói: ' + result.error;
                    return;
                }
                displayResult(result);
                loadHistory();
                document.getElementById('cameraStatus').textContent = 'ƒê√£ x·ª≠ l√Ω xong';
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('cameraStatus').textContent = 'L·ªói k·∫øt n·ªëi';
            } finally {
                // Hi·ªán l·∫°i stream sau khi ch·ª•p xong
                setTimeout(() => {
                    liveView.src = `http://${esp32_ip}/stream`;
                    liveView.style.display = '';
                }, 500);
            }
        }

        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        function displayResult(result) {
            if (result.error) {
                alert(result.error);
                return;
            }
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            let html = `
                <h5 style="color:#388e3c;">B·ªánh: ${result.class}</h5>
                <p>ƒê·ªô tin c·∫≠y: <span style="color:#fbc02d; font-weight:600;">${result.confidence.toFixed(2)}%</span></p>
                <h6 style="color:#388e3c;">X√°c su·∫•t c√°c l·ªõp:</h6>
            `;
            for (const [cls, prob] of Object.entries(result.probabilities)) {
                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${cls}</span>
                            <span>${prob.toFixed(2)}%</span>
                        </div>
                        <div class="confidence-bar" style="width: ${prob}%"></div>
                    </div>
                `;
            }
            resultContent.innerHTML = html;
            // Hi·ªÉn th·ªã th√¥ng tin b·ªánh c·ªë ƒë·ªãnh
            const info = result.info || {};
            let infoHtml = '';
            if (info.desc) {
                infoHtml += `<div class='alert alert-info'><b>M√¥ t·∫£:</b> ${info.desc}<br><b>Khuy·∫øn ngh·ªã:</b> ${info.solution}</div>`;
            }
            document.getElementById('diseaseInfo').innerHTML = infoHtml;

            // G·ªçi AI t·ª± ƒë·ªông tr·∫£ l·ªùi gi·∫£i ph√°p
            if (result.class) {
                const aiDiv = document.createElement('div');
                aiDiv.innerHTML = "<i>ƒêang l·∫•y gi·∫£i ph√°p AI...</i>";
                document.getElementById('diseaseInfo').appendChild(aiDiv);
                fetch('/chatbot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: `T√¥i ph√°t hi·ªán b·ªánh l√∫a: ${result.class}. H√£y t∆∞ v·∫•n gi·∫£i ph√°p ƒëi·ªÅu tr·ªã chi ti·∫øt cho t√¥i.` })
                })
                .then(res => res.json())
                .then(data => {
                    aiDiv.innerHTML = `<div class='alert alert-success'><b>AI t∆∞ v·∫•n:</b> ${data.answer}</div>`;
                })
                .catch(() => {
                    aiDiv.innerHTML = "<div class='alert alert-danger'>Kh√¥ng l·∫•y ƒë∆∞·ª£c t∆∞ v·∫•n AI.</div>";
                });
            }
            resultBox.classList.remove('d-none');
        }

        // L·ªãch s·ª≠ d·ª± ƒëo√°n
        async function loadHistory() {
            const res = await fetch('/history');
            const history = await res.json();
            let html = `<table class='table table-bordered table-sm'><thead><tr><th>Th·ªùi gian</th><th>·∫¢nh</th><th>K·∫øt qu·∫£</th><th>ƒê·ªô tin c·∫≠y</th><th>Ph∆∞∆°ng th·ª©c</th><th>Thao t√°c</th></tr></thead><tbody>`;
            for (let i = history.length - 1; i >= 0; i--) {
                const h = history[i];
                html += `<tr>
                    <td>${h.time}</td>
                    <td><img class='history-img' src='data:image/jpeg;base64,${h.image}' /></td>
                    <td>${h.result.class}</td>
                    <td>${h.result.confidence.toFixed(2)}%</td>
                    <td>${h.method || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                    <td>
                        <button onclick="deleteHistoryByTime('${h.time}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('historyTable').innerHTML = html;
        }

        async function deleteHistoryByTime(time) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y kh·ªèi l·ªãch s·ª≠?')) {
                try {
                    const response = await fetch(`/delete_history_by_time/${encodeURIComponent(time)}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('ƒê√£ x√≥a ·∫£nh th√†nh c√¥ng');
                        loadHistory();
                    } else {
                        alert('L·ªói: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('L·ªói khi x√≥a ·∫£nh');
                }
            }
        }

        // Th√™m h√†m hi·ªÉn th·ªã modal so s√°nh
        async function showCompareModal(originalImageName) {
            const modal = new bootstrap.Modal(document.getElementById('compareModal'));
            
            // Hi·ªÉn th·ªã ·∫£nh g·ªëc
            document.getElementById('originalImage').src = `/original_images/${originalImageName}`;
            
            // L·∫•y k·∫øt qu·∫£ d·ª± ƒëo√°n
            const res = await fetch('/compare_predictions');
            const history = await res.json();
            
            // L·ªçc c√°c d·ª± ƒëo√°n cho c√πng m·ªôt ·∫£nh
            const predictions = history.filter(h => h.result.original_image === originalImageName);
            
            let html = '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Th·ªùi gian</th><th>Ph∆∞∆°ng th·ª©c</th><th>K·∫øt qu·∫£</th><th>ƒê·ªô tin c·∫≠y</th></tr></thead><tbody>';
            
            predictions.forEach(pred => {
                html += `
                    <tr>
                        <td>${pred.time}</td>
                        <td>${pred.method || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                        <td>${pred.result.class}</td>
                        <td>${pred.result.confidence.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('predictionResults').innerHTML = html;
            
            modal.show();
        }

        // Webcam handling
        let webcamStream = null;
        const webcam = document.getElementById('webcam');
        const webcamCanvas = document.getElementById('webcamCanvas');
        const webcamStatus = document.getElementById('webcamStatus');
        const captureBtn = document.getElementById('captureBtn');

        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // ∆Øu ti√™n camera sau n·∫øu c√≥
                    } 
                });
                webcam.srcObject = webcamStream;
                webcamStatus.textContent = 'Camera ƒë√£ s·∫µn s√†ng';
                captureBtn.disabled = false;
            } catch (error) {
                console.error('Error accessing webcam:', error);
                webcamStatus.textContent = 'Kh√¥ng th·ªÉ truy c·∫≠p camera';
            }
        }

        async function captureAndPredict() {
            if (!webcamStream) return;
            
            try {
                webcamStatus.textContent = 'ƒêang x·ª≠ l√Ω...';
                captureBtn.disabled = true;
                
                // L·∫•y k√≠ch th∆∞·ªõc th·ª±c c·ªßa video
                const videoWidth = webcam.videoWidth;
                const videoHeight = webcam.videoHeight;
                
                // Thi·∫øt l·∫≠p canvas v·ªõi k√≠ch th∆∞·ªõc c·ªßa video
                webcamCanvas.width = videoWidth;
                webcamCanvas.height = videoHeight;
                
                // V·∫Ω frame hi·ªán t·∫°i t·ª´ video l√™n canvas
                const ctx = webcamCanvas.getContext('2d');
                ctx.drawImage(webcam, 0, 0, videoWidth, videoHeight);
                
                // Chuy·ªÉn canvas th√†nh base64 v·ªõi ch·∫•t l∆∞·ª£ng cao
                const imageData = webcamCanvas.toDataURL('image/jpeg', 0.95);
                
                // G·ª≠i ·∫£nh l√™n server
                const response = await fetch('/predict_webcam', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                });
                
                const result = await response.json();
                if (result.error) {
                    webcamStatus.textContent = 'L·ªói: ' + result.error;
                    return;
                }
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                displayResult(result);
                loadHistory();
                webcamStatus.textContent = 'ƒê√£ x·ª≠ l√Ω xong';
                
            } catch (error) {
                console.error('Error:', error);
                webcamStatus.textContent = 'L·ªói x·ª≠ l√Ω ·∫£nh';
            } finally {
                captureBtn.disabled = false;
            }
        }

        // Chatbot
        const chatbotMessages = document.getElementById('chatbotMessages');
        function appendChatbotMsg(msg, isUser) {
            const div = document.createElement('div');
            div.style.margin = '5px 0';
            div.style.textAlign = isUser ? 'right' : 'left';
            div.innerHTML = `<span style='background:${isUser ? "#e6f7ff" : "#f1f1f1"};padding:7px 14px;border-radius:14px;display:inline-block;'>${msg}</span>`;
            chatbotMessages.appendChild(div);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        async function sendChatbot() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            if (message) {
                const messagesDiv = document.getElementById('chatbotMessages');
                
                // Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.textContent = message;
                messagesDiv.appendChild(userMessageDiv);
                
                // G·ª≠i tin nh·∫Øn ƒë·∫øn server
                fetch('/chatbot', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: message })
                })
                .then(response => response.json())
                .then(data => {
                    // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi c·ªßa bot
                    const botMessageDiv = document.createElement('div');
                    botMessageDiv.className = 'chat-message bot-message';
                    botMessageDiv.textContent = data.answer;
                    messagesDiv.appendChild(botMessageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi g·ª≠i tin nh·∫Øn');
                });
                
                input.value = '';
            }
        }

        document.getElementById('chatbotInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendChatbot();
        });

        // Load history khi trang ƒë∆∞·ª£c t·∫£i
        loadHistory();

        async function showChatHistory() {
            const res = await fetch('/chatbot_history');
            const history = await res.json();
            let html = '';
            if (Array.isArray(history) && history.length > 0) {
                html += `<table class='table table-bordered'><thead><tr><th>Th·ªùi gian</th><th>C√¢u h·ªèi</th><th>Tr·∫£ l·ªùi</th></tr></thead><tbody>`;
                for (let i = history.length - 1; i >= 0; i--) {
                    const h = history[i];
                    html += `<tr>
                        <td>${h.time || ''}</td>
                        <td>${h.question || ''}</td>
                        <td>${h.answer || ''}</td>
                    </tr>`;
                }
                html += '</tbody></table>';
            } else {
                html = '<div class="alert alert-info">Ch∆∞a c√≥ l·ªãch s·ª≠ h·ªôi tho·∫°i n√†o.</div>';
            }
            document.getElementById('chatHistoryContent').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('chatHistoryModal'));
            modal.show();
        }

        // X·ª≠ l√Ω upload ·∫£nh trong chatbot
        document.getElementById('chatbotImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/chatbot_upload_image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messagesDiv = document.getElementById('chatbotMessages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'chat-message user-message';
                        messageDiv.innerHTML = `
                            <div>ƒê√£ g·ª≠i ·∫£nh</div>
                            <img src="data:image/jpeg;base64,${data.image}" class="chat-image">
                        `;
                        messagesDiv.appendChild(messageDiv);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        alert('L·ªói khi upload ·∫£nh: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi upload ·∫£nh');
                });
            }
        });

        // X·ª≠ l√Ω upload file trong chatbot
        document.getElementById('chatbotFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                
                fetch('/chatbot_upload_file', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const messagesDiv = document.getElementById('chatbotMessages');
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'chat-message user-message';
                        messageDiv.innerHTML = `
                            <div>ƒê√£ g·ª≠i file</div>
                            <div class="chat-file">
                                <i class="fas fa-file"></i>
                                <span>${data.filename}</span>
                            </div>
                        `;
                        messagesDiv.appendChild(messageDiv);
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    } else {
                        alert('L·ªói khi upload file: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('L·ªói khi upload file');
                });
            }
        });
    </script>
</body>
</html>